services:
  # ============================================================================
  # Ingestion Service
  # ============================================================================
  ingestion:
    build:
      context: ./ingestion
      dockerfile: Dockerfile
    container_name: rag_ingestion
    volumes:
      - ./ingestion:/app:rw  # Mount source code for live development
      - ./data_pdf:/app/data_pdf:ro
      - ./data_processed:/app/data_processed
      - ./postgres:/app/postgres:ro
      - ingestion_models:/app/models
      - ./.cache/huggingface:/root/.cache/huggingface:ro
    environment:
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-local}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      - WEAVIATE_URL=${WEAVIATE_URL:-http://weaviate_c:8080}
      - WEAVIATE_GRPC_URL=${WEAVIATE_GRPC_URL:-weaviate:50051}
      - WEAVIATE_API_KEY=${WEAVIATE_API_KEY:-}
      - HF_HOME=/root/.cache/huggingface
      - HF_HUB_CACHE=/root/.cache/huggingface/hub
      - TRANSFORMERS_CACHE=/root/.cache/huggingface
      - HF_HUB_OFFLINE=1
      - TRANSFORMERS_OFFLINE=1
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-postgres}
      - CHUNK_SIZE=${CHUNK_SIZE:-300}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-30}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - INGESTION_BATCH_SIZE=${INGESTION_BATCH_SIZE:-50}
      - ENABLE_OCR=${ENABLE_OCR:-false}
    networks:
      - rag_network
      - postgres_network
    depends_on:
      - retrieval
    restart: on-failure
    command: ["python", "main_fused.py"]

  # ============================================================================
  # Retrieval Service (FastAPI + MCP)
  # ============================================================================
  retrieval:
    build:
      context: ./retrieval
      dockerfile: Dockerfile
    container_name: rag_retrieval
    ports:
      - "8073:8073"
    volumes:
      - ./retrieval:/app:rw  # Mount source code for live development
      - retrieval_models:/app/models
      - ./data_pdf:/app/data_pdf:ro
      - ./data_processed:/app/data_processed:ro
      - ./.cache/huggingface:/root/.cache/huggingface:ro
    environment:
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-local}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      - WEAVIATE_URL=${WEAVIATE_URL:-http://weaviate_c:8080}
      - WEAVIATE_GRPC_URL=${WEAVIATE_GRPC_URL:-weaviate:50051}
      - WEAVIATE_API_KEY=${WEAVIATE_API_KEY:-}
      - HF_HOME=/root/.cache/huggingface
      - HF_HUB_CACHE=/root/.cache/huggingface/hub
      - TRANSFORMERS_CACHE=/root/.cache/huggingface
      - HF_HUB_OFFLINE=1
      - TRANSFORMERS_OFFLINE=1
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-postgres}
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-8073}
      - DEFAULT_TOP_K=${DEFAULT_TOP_K:-10}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MCP_ENABLE=${MCP_ENABLE:-false}
    networks:
      - rag_network
      - postgres_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8073/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Dash UI
  # ============================================================================
  dashapp:
    build:
      context: ./dashapp
      dockerfile: Dockerfile
    container_name: rag_dashapp
    ports:
      - "8072:8072"
    volumes:
      - ./dashapp:/app:rw  # Mount source code for live development
    environment:
      - DASH_HOST=${DASH_HOST:-0.0.0.0}
      - DASH_PORT=${DASH_PORT:-8072}
      - DASH_DEBUG=${DASH_DEBUG:-false}
      - RETRIEVAL_API_URL=${RETRIEVAL_API_URL:-http://retrieval:8073}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      - rag_network
    depends_on:
      - retrieval
    restart: unless-stopped

networks:
  rag_network:
    driver: bridge
    # Connect to external Weaviate network if needed
    external: true
    name: infrastructure_weaviate_network
  postgres_network:
    external: true
    name: postgres_network

volumes:
  ingestion_models:
    driver: local
  retrieval_models:
    driver: local

